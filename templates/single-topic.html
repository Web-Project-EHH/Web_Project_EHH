{% extends "base.html" %}
{% block title %}{{ topic.title }}{% endblock %}
{% block content %}
<main>
    <section id="topic-details" style="padding: 20px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; margin-bottom: 20px;">
        <h2 style="margin-bottom: 10px;">{{ topic.title }}</h2>
        <p><strong>Created by:</strong> <a href="/users/{{topic.user_id}}"> {{get_user_by_id(topic.user_id).username if get_user_by_id(topic.user_id)}} </a></p>
        <p><strong>Category:</strong> <a href="/categories/{{topic.category_id}}"> {{ get_category_by_id(current_user=get_user(request), category_id=topic.category_id)["Category"].name }}</a> </p>
        <p><strong>Best Reply:</strong> {{  get_reply_by_id(topic.best_reply_id).text if topic.best_reply_id else "None selected yet" }}</p>

        {% if get_user(request) and get_user(request).is_admin %}
            <div class="topic-actions" style="margin-top: 15px;">
                <button id="delete-topic" class="btn btn-danger" data-topic-id="{{ topic.topic_id }}" style="background-color: #d9534f; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 3px;">Delete Topic</button>
            </div>
        {% endif %}
    </section>

    <h3>Replies</h3>
    {% if replies %}
        <div style="margin-top: 20px;">
            {% for reply in replies %}
                {% if reply.text and reply.text.strip() %}
                    <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: {% if reply.id == topic.best_reply_id %}#e0c7f3{% else %}#f9f9f9{% endif %};">
                        <a href="/users/{{reply.user_id}}"><p><strong>{{ get_user_by_id(reply.user_id).username }}</a></strong> said:</p>
                        <p style="margin-top: 5px; white-space: pre-wrap;">{{ reply.text }}</p>
                        {% if reply.id == topic.best_reply_id %}
                            <p style="margin-top: 10px; font-weight: bold; color: #4c2882; cursor: default;">Best Reply</p>
                        {% else %}
                            {% if get_user(request).id == topic.user_id %}
                                <button class="set-best-reply" data-reply-id="{{ reply.id }}" style="margin-top: 10px; background-color: #5cb85c; color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 3px;">Select as Best Reply</button>
                            {% endif %}
                            {% if get_user(request).id == reply.user_id %}
                                <button class="delete-reply" data-reply-id="{{ reply.id }}" style="margin-top: 10px; background-color: #d9534f; color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 3px;">Delete Reply</button>
                            {% endif %}
                            {% if get_user(request).is_admin %}
                            {% endif %}
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    {% else %}
        <p>No replies found.</p>
    {% endif %}

    <div>
        <form method="POST" action="{{topic.topic_id}}/create">
            <input type="hidden" name="topic_id" value="{{ topic.topic_id }}">
            <label for="text">Reply:</label>
            <textarea id="text" name="text" rows="5" cols="50" required></textarea>
            <button type="submit">Reply</button>
        </form>
    </div>
</main>

<script>
document.querySelectorAll('.delete-reply').forEach(button => {
    button.addEventListener('click', async function() {
        const replyId = this.getAttribute('data-reply-id');
        const url = `/replies/${replyId}/delete`;
        try {
            const response = await fetch(url, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                alert(errorData.error || 'An error occurred');
            } else {
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });
});
document.getElementById('delete-topic')?.addEventListener('click', async function() {
    const topicId = this.getAttribute('data-topic-id');
    
    if (confirm('Are you sure you want to delete this topic? This action cannot be undone.')) {
        try {
            const response = await fetch(`/topics/${topicId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                alert(errorData.error || 'An error occurred');
            } else {
                window.location.href = '/topics';  // Redirect to topics list after deletion
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }
});
document.querySelectorAll('.set-best-reply').forEach(button => {
    button.addEventListener('click', async function() {
        const replyId = this.getAttribute('data-reply-id');
        const url = `/topics/{{ topic.topic_id }}/best_reply`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ best_reply_id: replyId })
            });

            if (!response.ok) {
                const errorData = await response.json();
                alert(errorData.error || 'An error occurred');
            } else {
                // Change button text and disable it to indicate it was selected
                this.innerText = 'Best Reply Selected';
                this.disabled = true;
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });
});
</script>
{% endblock %}
